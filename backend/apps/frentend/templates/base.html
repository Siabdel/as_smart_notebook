{% load static %}

<!DOCTYPE html
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart-Notebook • Votre IA Documentaire Personnelle</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts - Design distinctif -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">

   
</head>
<body>
    <div id="app">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
            <div class="container">
                <a class="logo" href="#">Smart-Notebook</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#upload">Upload</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#chat">Questions</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#documents">Documents</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
        {% block content %}{% endblock %}

        <!-- Hero Section -->
        <section class="hero">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-6 fade-in stagger-1">
                        <h1 class="hero-title">
                            Interrogez vos<br>documents<br>avec l'IA
                        </h1>
                        <p class="hero-subtitle">
                            Uploadez vos PDFs, posez vos questions. Smart-Notebook extrait les réponses 
                            et cite ses sources grâce à l'IA hybride locale + cloud.
                        </p>
                        <button class="btn btn-primary-custom" @click="scrollToUpload">
                            <span>Commencer maintenant</span>
                        </button>
                    </div>
                    
                    <div class="col-lg-6 fade-in stagger-2">
                        <div class="glass-card">
                            <div class="row">
                                <div class="col-4 stat-card">
                                    <div class="stat-number">[[ stats.total_documents ]]</div>
                                    <div class="stat-label">Documents</div>
                                </div>
                                <div class="col-4 stat-card">
                                    <div class="stat-number">[[ stats.total_chunks ]]</div>
                                    <div class="stat-label">Chunks</div>
                                </div>
                                <div class="col-4 stat-card">
                                    <div class="stat-number">[[ formatNumber(stats.total_characters) ]]</div>
                                    <div class="stat-label">Caractères</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="py-5">
            <div class="container">
                <div class="row g-4">
                    <div class="col-md-4 fade-in stagger-3">
                        <div class="glass-card h-100">
                            <div class="feature-icon">
                                <i class="bi bi-lightning-charge-fill"></i>
                            </div>
                            <h3 class="mb-3">IA Hybride</h3>
                            <p class="text-secondary">
                                Embeddings locaux (Ollama) + Génération cloud (Claude 3.5) 
                                pour un équilibre parfait entre coût et qualité.
                            </p>
                        </div>
                    </div>
                    
                    <div class="col-md-4 fade-in stagger-4">
                        <div class="glass-card h-100">
                            <div class="feature-icon">
                                <i class="bi bi-search"></i>
                            </div>
                            <h3 class="mb-3">Recherche Vectorielle</h3>
                            <p class="text-secondary">
                                Powered by pgvector : trouvez les passages pertinents 
                                instantanément avec la recherche sémantique.
                            </p>
                        </div>
                    </div>
                    
                    <div class="col-md-4 fade-in">
                        <div class="glass-card h-100">
                            <div class="feature-icon">
                                <i class="bi bi-book"></i>
                            </div>
                            <h3 class="mb-3">Sources Citées</h3>
                            <p class="text-secondary">
                                Chaque réponse inclut les sources exactes (document + page) 
                                pour une transparence totale.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Upload Section -->
        <section id="upload" class="py-5">
            <div class="container">
                <h2 class="text-center mb-5" style="font-family: var(--font-display); font-size: 2.5rem;">
                    Upload vos documents
                </h2>
                
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="glass-card">
                            <div 
                                class="upload-zone"
                                :class="{ dragover: isDragging }"
                                @click="triggerFileInput"
                                @dragover.prevent="isDragging = true"
                                @dragleave.prevent="isDragging = false"
                                @drop.prevent="handleFileDrop"
                            >
                                <div class="upload-icon">
                                    <i class="bi bi-cloud-upload"></i>
                                </div>
                                <h4>Glissez-déposez vos PDFs ici</h4>
                                <p class="text-secondary mb-0">ou cliquez pour parcourir (50 MB max)</p>
                                <input 
                                    type="file" 
                                    ref="fileInput" 
                                    @change="handleFileSelect"
                                    accept=".pdf,.txt"
                                    style="display: none"
                                    multiple
                                >
                            </div>
                            
                            <!-- Upload Progress -->
                            <div v-if="uploadProgress.length > 0" class="mt-4">
                                <div v-for="(file, index) in uploadProgress" :key="index" class="mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>[[ file.name ]]</span>
                                        <span>[[ file.status ]]</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div 
                                            class="progress-bar" 
                                            :class="file.status === 'Terminé' ? 'bg-success' : 'bg-info'"
                                            role="progressbar" 
                                            :style="{ width: file.progress + '%' }"
                                        ></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Chat Section -->
        <section id="chat" class="py-5">
            <div class="container">
                <h2 class="text-center mb-5" style="font-family: var(--font-display); font-size: 2.5rem;">
                    Posez vos questions
                </h2>
                
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <div class="glass-card">
                            <!-- Chat Container -->
                            <div class="chat-container" ref="chatContainer">
                                <div v-if="messages.length === 0" class="text-center text-secondary" style="padding: 4rem 0;">
                                    <i class="bi bi-chat-dots" style="font-size: 4rem; opacity: 0.3;"></i>
                                    <p class="mt-3">Commencez une conversation avec vos documents...</p>
                                </div>
                                
                                <div v-for="(message, index) in messages" :key="index" class="chat-message" :class="message.role === 'user' ? 'message-user' : 'message-assistant'">
                                    <div class="message-bubble">
                                        <div v-html="message.content"></div>
                                        
                                        <!-- Sources -->
                                        <div v-if="message.sources && message.sources.length > 0" class="mt-3">
                                            <strong style="font-family: var(--font-mono); font-size: 0.85rem;">Sources citées :</strong>
                                            <div v-for="(source, idx) in message.sources" :key="idx" class="source-card">
                                                <div class="source-title">[[ source.document_title ]]</div>
                                                <div class="text-secondary" style="font-size: 0.85rem;">
                                                    Page [[ source.page || 'N/A' ]] • Pertinence: [[ (source.relevance_score * 100).toFixed(0) ]]%
                                                </div>
                                                <div class="mt-2" style="font-size: 0.9rem; font-style: italic;">
                                                    "[[ source.excerpt ]]"
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div v-if="isLoadingAnswer" class="chat-message message-assistant">
                                    <div class="message-bubble">
                                        <div class="d-flex align-items-center">
                                            <div class="spinner me-3"></div>
                                            <span>Recherche dans les documents...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Input -->
                            <div class="d-flex gap-2">
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    v-model="currentQuestion"
                                    @keyup.enter="askQuestion"
                                    placeholder="Posez votre question..."
                                    :disabled="isLoadingAnswer"
                                >
                                <button 
                                    class="btn btn-primary-custom" 
                                    @click="askQuestion"
                                    :disabled="isLoadingAnswer || !currentQuestion.trim()"
                                    style="padding: 0.8rem 2rem;"
                                >
                                    <span><i class="bi bi-send-fill"></i></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Documents List Section -->
        <section id="documents" class="py-5">
            <div class="container">
                <h2 class="text-center mb-5" style="font-family: var(--font-display); font-size: 2.5rem;">
                    Vos documents
                </h2>
                
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <div v-if="documents.length === 0" class="text-center text-secondary glass-card" style="padding: 4rem;">
                            <i class="bi bi-file-earmark-text" style="font-size: 4rem; opacity: 0.3;"></i>
                            <p class="mt-3">Aucun document uploadé pour le moment.</p>
                        </div>
                        
                        <div v-else>
                            <div v-for="doc in documents" :key="doc.id" class="document-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h4 class="document-title">[[ doc.title ]]</h4>
                                        <div class="d-flex gap-2 flex-wrap mb-2">
                                            <span class="badge-custom" :class="'badge-' + doc.processing_status.toLowerCase()">
                                                [[ doc.processing_status ]]
                                            </span>
                                            <span class="badge-custom" style="background: rgba(168, 178, 209, 0.2); color: var(--text-secondary);">
                                                [[ formatFileSize(doc.file_size) ]]
                                            </span>
                                            <span v-if="doc.total_chunks > 0" class="badge-custom" style="background: rgba(0, 255, 157, 0.1); color: var(--accent);">
                                                [[ doc.total_chunks ]] chunks
                                            </span>
                                        </div>
                                        <p class="text-secondary mb-0" style="font-size: 0.9rem;">
                                            Uploadé le [[ formatDate(doc.created_at) ]]
                                        </p>
                                    </div>
                                    <button 
                                        class="btn btn-sm btn-outline-danger"
                                        @click="deleteDocument(doc.id)"
                                        style="border-color: var(--danger); color: var(--danger);"
                                    >
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="py-5 text-center text-secondary">
            <div class="container">
                <p style="font-family: var(--font-mono);">
                    Smart-Notebook • Powered by Django + Vue.js + Ollama + OpenRouter
                </p>
                <p class="mb-0"> <i class="bi bi-github"></i> Open Source • Made with ❤️ </p>
            </div>
        </footer>
    </div>
  <!-- Vue 3 -->
<script src="https://cdn.jsdelivr.net/npm/vue@3.4.15/dist/vue.global.prod.js"></script>

<!-- Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios@1.6.5/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'js/app.js' %}"></script>
</body>
</html>